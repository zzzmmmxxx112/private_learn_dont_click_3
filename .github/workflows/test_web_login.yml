name: 登录功能自动化测试

# 触发条件：push到main分支、手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

# 工作流执行环境
jobs:
  login-test:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取代码到运行环境
      - name: 检出代码
        uses: actions/checkout@v4

      # 步骤2：配置Python环境（匹配项目依赖）
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'  # 适配Flask/Selenium兼容性
          # cache: 'pip'  # 缓存pip依赖，加速构建

      # 步骤3：安装Python依赖
      - name: 安装依赖包
        run: |
          python -m pip install --upgrade pip
          pip install flask pytest selenium webdriver-manager sqlite3  # 项目核心依赖

      # 步骤4：安装Chrome浏览器（Ubuntu环境）
      - name: 安装Chrome浏览器
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          # 配置Chrome驱动路径
          export PATH=$PATH:/usr/lib/chromium-browser/

      # 步骤5：后台启动Flask登录服务
      - name: 启动Flask后端服务
        run: |
          nohup python target_web_login.py > flask_logs.txt 2>&1 &
          # 等待服务启动（避免端口未就绪）
          sleep 10
          # 验证服务是否启动
          curl -f http://localhost:5000/login || (echo "Flask服务启动失败" && exit 1)

      # 步骤6：执行密码重置脚本（初始化测试环境）
      - name: 重置Admin用户密码
        run: python resetPassword.py

      # 步骤7：执行UI自动化测试（生成测试报告）
      - name: 运行Pytest测试用例
        run: |
          pytest test_login.py -v --tb=short --junitxml=test-results.xml
        continue-on-error: false  # 测试失败则终止流程（可根据需求改为true）

      # 步骤8：上传测试失败截图（若有）
      - name: 上传测试失败截图
        uses: actions/upload-artifact@v4
        if: failure()  # 仅测试失败时上传
        with:
          name: login-test-screenshots
          path: |
            *.png
            flask_logs.txt
            test-results.xml

      # 步骤9：上传测试报告
      - name: 上传测试报告
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
